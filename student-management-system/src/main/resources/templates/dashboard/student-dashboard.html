<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</head>
<body class="bg-gray-100">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-72 bg-gradient-to-b from-indigo-800 to-indigo-700 text-white p-6 space-y-6">
        <h2 class="text-2xl font-bold mb-6 text-center">Student Panel</h2>
        <ul class="space-y-4">
            <li><a href="#dashboard" onclick="showSection('dashboard')" class="hover:underline">Dashboard</a></li>
            <li><a href="#allCourses" onclick="showSection('allCourses')" class="hover:underline">Courses</a></li>
            <li><a href="#courses" onclick="showSection('courses')" class="hover:underline">My Courses</a></li>
            <li><a href="#attendance" onclick="showSection('attendance')" class="hover:underline">Attendance</a></li>
            <li><a href="/student/fees" class="hover:underline">Fee Payment</a></li>
            <li><a href="#profile" onclick="showSection('profile')" class="hover:underline">Profile</a></li>
            <li><a href="#settings" onclick="showSection('settings')" class="hover:underline">Settings</a></li>
        </ul>
    </div>

    <!-- Content Area -->
    <div class="flex-1 p-8 overflow-y-auto">
        <!-- Dashboard Default Section -->
        <div id="dashboard" class="section p-6 space-y-8">
            <!-- Greeting -->
            <h1 class="text-3xl font-bold text-indigo-800">Welcome, <span th:text="${studentName}">Student</span>!</h1>

            <!-- Important Announcement -->
            <div class="bg-gradient-to-r from-indigo-100 to-blue-100 border-l-4 border-indigo-600 text-indigo-800 p-6 rounded-2xl shadow-md">
                <div class="flex items-start gap-4">
                    <div class="text-3xl">📢</div>
                    <div>
                        <h2 class="text-lg font-semibold">Important Announcements</h2>
                        <ul class="mt-2 space-y-1 text-sm list-disc list-inside">
                            <li><strong>Odd semester 2025-26 registration</strong> is now <span class="text-green-600 font-medium">open</span>.</li>
                            <li><strong>University reopening date:</strong> <span class="text-blue-600 font-medium">07.07.2025</span></li>
                            <li>Ensure fee payment before the deadline.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Overall Attendance Chart -->
            <!-- Attendance Section -->
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Donut Chart: Overall Attendance -->
                <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md">
                    <h2 class="text-xl font-semibold text-indigo-700 mb-4">📊 Overall Attendance</h2>
                    <canvas id="overallAttendanceChart" width="140" height="140"></canvas>
                </div>

                <!-- Bar Chart: Monthly Attendance -->
                <div class="bg-white rounded-2xl shadow-lg p-6 flex-1">
                    <h2 class="text-xl font-semibold text-indigo-700 mb-4">📈 Attendance - Monthly Graph Sheet</h2>
                    <canvas id="dailyAttendanceChart" width="600" height="300"></canvas>
                </div>
            </div>


            <!-- New: Academic Calendar Highlights -->
            <div class="bg-white rounded-2xl shadow-md p-6">
                <h2 class="text-lg font-semibold text-indigo-700 mb-4">📅 Academic Calendar Highlights</h2>
                <ul class="text-sm list-disc list-inside space-y-2">
                    <li><strong>Mid-Term Exams:</strong> 12–18 August 2025</li>
                    <li><strong>Project Submission:</strong> 28 August 2025</li>
                    <li><strong>Semester Exams:</strong> Start from 20 September 2025</li>
                </ul>
            </div>

            <!-- New: Quick Support Info -->
            <div class="bg-indigo-50 border-l-4 border-indigo-500 rounded-2xl p-6 text-sm text-indigo-800 shadow-sm">
                <h2 class="text-md font-semibold mb-2">💬 Need Help?</h2>
                <p>For any technical or academic help, contact the Student Affairs Office at <a href="mailto:support@university.edu" class="underline text-blue-600">support@university.edu</a>.</p>
            </div>
        </div>





        <!-- My Courses (Enrolled) -->
        <div id="courses" class="section hidden">
            <h1 class="text-2xl font-bold mb-6 text-indigo-700">My Courses</h1>

            <!-- Semester Filter Dropdown -->
            <div class="mb-4">
                <label class="text-sm font-medium text-gray-700 mr-2">Filter by Semester:</label>
                <select id="myCourseSemesterFilter" onchange="filterMyCourses()"
                        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="all">All</option>
                    <option th:each="sem : ${uniqueSemesters}" th:value="${sem}" th:text="${sem}"></option>
                </select>
            </div>

            <!-- Course Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div th:if="${#lists.isEmpty(enrolledCourses)}" class="col-span-3 text-gray-500 italic">
                    You are not enrolled in any courses yet.
                </div>

                <div th:each="course : ${enrolledCourses}"
                     class="my-course-card bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300"
                     th:attr="data-semester=${course.semester}">
                    <h2 class="text-lg font-semibold text-indigo-700" th:text="${course.name}">Course Name</h2>
                    <p class="text-sm text-gray-600 mt-1">Code: <span th:text="${course.code}"></span></p>
                    <p class="text-sm text-gray-600">Semester: <span th:text="${course.semester}"></span></p>
                    <p class="text-sm text-gray-600">Department: <span th:text="${course.department}"></span></p>
                    <p class="text-sm text-gray-500 mt-2 italic" th:text="${course.description}">Course description</p>
                </div>
            </div>
        </div>




        <!-- All Available Courses -->
        <div id="allCourses" class="section hidden">
            <h1 class="text-2xl font-bold mb-4 text-indigo-700">All Available Courses</h1>

            <!-- Semester Filter -->
            <div class="mb-6">
                <label for="semesterFilter" class="block mb-2 text-sm font-medium text-gray-700">Filter by Semester:</label>
                <select id="semesterFilter" onchange="filterCourses()" class="w-1/3 p-2 rounded border border-gray-300">
                    <option value="all">All Semesters</option>
                    <th:block th:each="semester : ${uniqueSemesters}">
                        <option th:value="${semester}" th:text="${semester}">Semester</option>
                    </th:block>
                </select>
            </div>

            <!-- Course Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="courseContainer">
                <p th:if="${#lists.isEmpty(courses)}" class="text-gray-500 italic col-span-2">No courses available for your department.</p>
                <div th:each="course : ${courses}" class="course-card bg-white p-6 rounded-2xl shadow-md flex flex-col justify-between"
                     th:data-semester="${course.semester}">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2" th:text="${course.name}">Course Name</h2>
                        <p class="text-sm text-gray-600 mb-4" th:text="${course.description}">Description</p>
                        <p class="text-sm text-gray-500">Semester: <span th:text="${course.semester}"></span></p>
                    </div>
                    <form th:action="@{/student/enroll}" method="post" class="inline">
                        <input type="hidden" name="courseCode" th:value="${course.code}" />
                        <button type="submit"
                                th:disabled="${#lists.contains(enrolledCourses, course)}"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                            <span th:text="${#lists.contains(enrolledCourses, course) ? 'Enrolled' : 'Enroll'}"></span>
                        </button>
                    </form>

                </div>
            </div>
        </div>

        <div id="attendance" class="section hidden">
            <h1 class="text-2xl font-bold mb-6 text-indigo-700">📅 Attendance</h1>

            <div th:each="course : ${enrolledCourses}" x-data="{ open: false }"
                 class="bg-white shadow-lg rounded-2xl p-6 mb-6 border border-gray-200 transition-all">

                <!-- Card Header -->
                <div class="flex justify-between items-center cursor-pointer" @click="open = !open">
                    <div>
                        <h2 class="text-lg font-semibold text-indigo-700" th:text="${course.name}">Course Name</h2>
                        <p class="text-sm text-gray-500 mt-1">Click to view attendance</p>
                    </div>

                    <!-- Right side: Percentage + Toggle Icon -->
                    <div class="flex items-center space-x-4">
                <span class="text-sm font-bold flex items-center gap-1"
                      th:classappend="${attendancePercentages[course.id] >= 75 ? 'text-green-600' :
                       (attendancePercentages[course.id] >= 50 ? 'text-yellow-600' : 'text-red-600')}"
                      th:text="${attendancePercentages[course.id] != null ?
                (attendancePercentages[course.id] >= 75 ? '✅ ' :
                 (attendancePercentages[course.id] >= 50 ? '⚠️ ' : '❌ '))
                 + attendancePercentages[course.id] + '%' : '--%'}">
    --%
</span>


                        <!-- Chevron Icon -->
                        <svg :class="{'rotate-180': open}" class="w-5 h-5 transform transition-transform duration-300 text-indigo-600"
                             fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>

                <!-- Attendance Details -->
                <div x-show="open" x-transition
                     class="mt-4 p-4 bg-gray-50 border border-indigo-100 rounded-xl shadow-inner transition duration-300">
                <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4">Date</th>
                            <th class="py-2 px-4">Status</th>
                        </tr>
                        </thead>
                        <tbody th:if="${detailedAttendanceMap != null and detailedAttendanceMap[course.id] != null}">
                        <tr th:each="record : ${detailedAttendanceMap[course.id]}" class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4" th:text="${#temporals.format(record.date, 'dd MMM yyyy')}">01 Jul 2025</td>
                            <td class="py-2 px-4">
                                <span th:if="${record.present}" class="text-green-600 font-semibold">Present ✅</span>
                                <span th:if="${!record.present}" class="text-red-600 font-semibold">Absent ❌</span>
                            </td>
                        </tr>
                        </tbody>
                        <tbody th:if="${detailedAttendanceMap == null or detailedAttendanceMap[course.id] == null}">
                        <tr>
                            <td colspan="2" class="py-2 px-4 text-gray-500 italic">No attendance records found.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>






        <!-- Profile -->
        <!-- Profile Section -->
        <div id="profile" class="section hidden px-4 py-8">
            <h1 class="text-3xl font-extrabold mb-8 text-indigo-700 text-center">My Profile</h1>

            <div class="bg-white rounded-2xl shadow-2xl max-w-5xl mx-auto p-8 md:p-12">
                <!-- Avatar and Basic Info -->
                <div class="flex flex-col md:flex-row items-center gap-8 mb-10">
                    <!-- Avatar -->
                    <div class="flex-shrink-0">
                        <div class="w-32 h-32 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 text-4xl font-bold shadow-inner">
                            <span th:text="${student.name != null ? student.name.substring(0,1) : '🧑‍🎓'}">🧑‍🎓</span>
                        </div>
                    </div>

                    <!-- Name & Email -->
                    <div class="text-center md:text-left space-y-1">
                        <h2 class="text-3xl font-semibold text-gray-800" th:text="${student.name}">Student Name</h2>
                        <p class="text-sm text-gray-500 italic">"Learning every day is a step toward your dream."</p>
                    </div>
                </div>

                <!-- Detailed Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <p class="text-sm text-gray-500">Student ID</p>
                        <p class="text-lg font-medium text-gray-800" th:text="${student.id}">123456</p>
                    </div>

                    <div>
                        <p class="text-sm text-gray-500">Email</p>
                        <p class="text-lg font-medium text-gray-800" th:text="${student.email}">student@example.com</p>
                    </div>

                    <div>
                        <p class="text-sm text-gray-500">Department</p>
                        <p class="text-lg font-medium text-gray-800" th:text="${student.department}">Computer Science</p>
                    </div>

                    <div>
                        <p class="text-sm text-gray-500">Phone Number</p>
                        <p class="text-lg font-medium text-gray-800" th:text="${student.phone}">+91 9876543210</p>
                    </div>






                </div>

                <!-- Optional Quote or Status -->
                <div class="mt-10 text-center">
                    <p class="text-indigo-600 font-medium italic text-sm">"Empowered by knowledge, driven by curiosity."</p>
                </div>
            </div>
        </div>


        <!-- Settings -->
        <div id="settings" class="section hidden">
            <h1 class="text-2xl font-bold mb-4 text-indigo-700">Settings</h1>
            <div class="bg-white p-6 rounded-2xl shadow-md space-y-4">
                <button class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Change Password</button>
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- JavaScript -->
<script>
    function showSection(id) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
        const target = document.getElementById(id);
        if (target) {
            target.classList.remove('hidden');
        }
    }

    function filterCourses() {
        const selectedSemester = document.getElementById('semesterFilter').value;
        const cards = document.querySelectorAll('.course-card');
        cards.forEach(card => {
            const semester = card.getAttribute('data-semester');
            card.style.display = (selectedSemester === 'all' || semester === selectedSemester) ? 'flex' : 'none';
        });
    }

    function filterMyCourses() {
        const selectedSemester = document.getElementById('myCourseSemesterFilter').value;
        const cards = document.querySelectorAll('.my-course-card');
        cards.forEach(card => {
            const semester = card.getAttribute('data-semester');
            card.style.display = (selectedSemester === 'all' || semester === selectedSemester) ? 'block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const initialHash = window.location.hash.substring(1);
        showSection(initialHash || 'dashboard');

        const toast = document.getElementById('toast-message');
        if (toast) {
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-10');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-10');
            }, 3000);

            setTimeout(() => {
                toast.remove();
            }, 3500);
        }
    });
</script>



<script th:inline="javascript">
    const overallAttendance = Math.round(/*[[${overallAttendance}]]*/ 0);
    const ctxOverall = document.getElementById('overallAttendanceChart').getContext('2d'); // ✅ Changed variable name

    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function(chart) {
            const width = chart.width;
            const height = chart.height;
            const ctx = chart.ctx;
            ctx.restore();
            const fontSize = (height / 114).toFixed(2);
            ctx.font = fontSize + "em sans-serif";
            ctx.textBaseline = "middle";
            const text = overallAttendance + '%';
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 2.3;
            ctx.fillStyle = "#111827";
            ctx.fillText(text, textX, textY);

            ctx.font = "0.9em sans-serif";
            const subText = "Overall Attendance";
            const subTextX = Math.round((width - ctx.measureText(subText).width) / 2);
            const subTextY = height / 1.8;
            ctx.fillStyle = "#6B7280";
            ctx.fillText(subText, subTextX, subTextY);
            ctx.save();
        }
    };

    new Chart(ctxOverall, { // ✅ Use ctxOverall
        type: 'doughnut',
        data: {
            labels: ['Present (%)', 'Absent (%)'],
            datasets: [{
                data: [overallAttendance, 100 - overallAttendance],
                backgroundColor: ['#6366F1', '#E5E7EB'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        },
        plugins: [centerTextPlugin]
    });
</script>

<script th:inline="javascript">
    // 👇 These values are injected by Thymeleaf
     const labels = JSON.parse([[${dailyLabels}]]);
    const data = JSON.parse([[${dailyData}]]);

    const ctx = document.getElementById('dailyAttendanceChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Attendance %',
                data: data,
                fill: true,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: '#4bc0c0',
                pointBackgroundColor: '#4bc0c0',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Attendance Trend - This Month'
                },
                tooltip: {
                    callbacks: {
                        label: context => `Attendance: ${context.parsed.y}%`
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Attendance (%)'
                    },
                    ticks: {
                        callback: value => value + '%'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
</script>
</body>
</html>
